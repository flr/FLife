---
title: "Density Dependence"
author: "Laurence Kell"
date: "21/07/2014"
output: word_document
---
  
```{r knitr, echo=FALSE}
library(knitr)

opts_chunk$set(comment=NA, 
               fig.width =8, 
               fig.height=4,
               fig.path  ="tex/dd",
               warnings=FALSE, 
               message=FALSE, 
               error  =FALSE, 
               echo   =FALSE, 
               eval   =TRUE,
               cache  =TRUE)
iFig=0
```

```{r init}
library(ggplot2)
library(FLCore)
library(FLBRP)
library(ggplotFL)
library(FLife)
library(reshape2)
library(plyr)

theme_set(theme_bw())

data(teleost)

alb=lhPar(teleost[,"Thunnus alalunga"])
bh9=lhEql(alb)

fbarMult=c(rep(0,50),seq(0,3,length.out=100),seq(3,.7,length.out=10),rep(0.7,40))

fbar(bh9)=refpts(bh9)["msy","harvest"]*fbarMult
stk=fwd(bh9)
ref=stock.n(bh9)[,30]%*%stock.wt(bh9)
```

# Simulations
```{r M}
stkM=fwd(bh9)

###Projections
for (i in seq(dim(fbar(stkM))[2])[-1]){
  
  scale=((stock.n(stkM[,i])%*%stock.wt(stkM[,i]))%-%ref)%/%ref
  
  m(stkM[,i])=mdd(vonB(ages(m(stk)[,i])+0.5,alb),params=alb,scale,k=0.5) 
  
  stkM=fwd(stkM,f=fbar(stkM[,i]),sr=bh9)}
```

```{r Mat}
stkMat=fwd(bh9)

for (i in seq(dim(fbar(stkMat))[2])[-1]){
  
  scale=((stock.n(stkMat[,i])%*%stock.wt(stkMat[,i]))%-%ref)%/%ref
  
  mat(stkMat[,i])[]=matdd(ages(stock.wt(stkMat[,i]))+alb["a50"]-as.integer(alb["a50"]),
                          params=alb,scale,k=2.5) 
  
  stkMat=fwd(stkMat,f=fbar(stkMat[,i]),sr=bh9)}
```

```{r Grw}
stkGrw=fwd(bh9)

for (i in seq(dim(fbar(stkGrw))[2])[-1]){
  
  scale=((stock.n(stkGrw[,i])%*%stock.wt(stkGrw[,i]))%-%ref)%/%ref
  
  stock.wt(stkGrw[,i])[]=len2wt(grwdd(ages(stock.wt(stkGrw[,i]))+alb["a50"]-as.integer(alb["a50"]),
                                      params=alb,scale,k=0.35),alb)
  catch.wt(stkGrw[,i])[]=len2wt(grwdd(ages(stock.wt(stkGrw[,i]))+0.5,
                                      params=alb,scale,k=0.35),alb)
  
  stkGrw=fwd(stkGrw,f=fbar(stkGrw[,i]),sr=bh9)}
```

# Equilibrium

```{r eqlM}
scale =(stock.n(bh9)%*%stock.wt(bh9))
scale =(scale%-%scale[,1])%/%scale[,1]

eqlM=bh9
m(eqlM)=FLQuant(NA,dimnames=dimnames(stock.n(bh9)))
for (i in seq(dim(fbar(eqlM))[2]))
  m(eqlM)[,i]=mdd(vonB(ages(m(eqlM)[,i])+0.5,alb),params=alb,scale[,i],k=0.5) 
save(eqlM,bh9,file="/home/laurie/Desktop/tmp/eqlM.RData")
```

```{r eqlMat}
eqlMat=bh9
mat(eqlMat)=FLQuant(NA,dimnames=dimnames(stock.n(bh9)))

for (i in seq(dim(fbar(eqlMat))[2]))
  mat(eqlMat)[,i]=matdd(ages(stock.wt(eqlMat))+alb["a50"]-as.integer(alb["a50"]),
                        params=alb,scale[,i],k=2.5) 
```

```{r eqlGrw}
eqlGrw=bh9
stock.wt(eqlGrw)   =FLQuant(NA,dimnames=dimnames(stock.n(bh9)))
landings.wt(eqlGrw)=FLQuant(NA,dimnames=dimnames(stock.n(bh9)))
discards.wt(eqlGrw)=FLQuant(NA,dimnames=dimnames(stock.n(bh9)))

for (i in seq(dim(fbar(eqlM))[2])){
  stock.wt(eqlGrw)[,i][]=len2wt(grwdd(ages(stock.wt(eqlGrw)[,i])+alb["a50"]-as.integer(alb["a50"]),
                                      params=alb,scale[,i],k=0.3),alb)
  landings.wt(eqlGrw)[,i][]=len2wt(grwdd(ages(stock.wt(eqlGrw)[,i])+0.5,
                                      params=alb,scale[,i],k=0.35),alb)
  discards.wt(eqlGrw)[,i][]=len2wt(grwdd(ages(stock.wt(eqlGrw)[,i])+0.5,
                                      params=alb,scale[,i],k=0.35),alb)
  }
```

#Figures
```{r fig1, fig.height=10}

refs<-function(stk,eql){
       as.data.frame(FLQuants(rec    =rec(  stk)/max(rec(stk)),
                              SSB    =ssb(  stk)/max(ssb(stk)),
                              Biomass=stock(stk)/max(stock(stk)),
                              Yield  =catch(stk)/max(catch(stk),na.rm=TRUE),
                              Harvest=fbar( stk)/max(fbar(stk))))}

rfs=rbind(cbind(Scenario="SRR",refs(stk)),
          cbind(Scenario="M",  refs(stkM)),
          cbind(Scenario="Mat",refs(stkMat)),
          cbind(Scenario="Grw",refs(stkGrw)))

ggplot(subset(rfs,year>=55))+
  geom_line(aes(year,data,col=Scenario))+
  facet_grid(qname~.,scale="free_y")+
  theme(legend.position="bottom")
```
**Figure `r iFig=iFig+1;iFig`.** Time series for different assumptions about density dependence.

```{r fig2}
eql=rbind(
cbind(Scenario="SRR",
      model.frame(FLQuants(bh9,   "rec"=rec,"SSB"=ssb,"Biomass"=stock,"Yield"=catch,"Harvest"=fbar))),
cbind(Scenario="M",
      model.frame(FLQuants(eqlM,  "rec"=rec,"SSB"=ssb,"Biomass"=stock,"Yield"=catch,"Harvest"=fbar))),
cbind(Scenario="Mat",
      model.frame(FLQuants(eqlMat,"rec"=rec,"SSB"=ssb,"Biomass"=stock,"Yield"=catch,"Harvest"=fbar))),
cbind(Scenario="Grw",
      model.frame(FLQuants(eqlGrw,"rec"=rec,"SSB"=ssb,"Biomass"=stock,"Yield"=catch,"Harvest"=fbar))))

ref2<-function(stk,eql){
       as.data.frame(FLQuants(rec    =rec(  stk),
                              SSB    =ssb(  stk),
                              Biomass=stock(stk),
                              Yield  =catch(stk),
                              Harvest=fbar( stk)))}

rf2=rbind(cbind(Scenario="SRR",ref2(stk)),
          cbind(Scenario="M",  ref2(stkM)),
          cbind(Scenario="Mat",ref2(stkMat)),
          cbind(Scenario="Grw",ref2(stkGrw)))

ggplot(cast(rf2[,c(1,3,8:9)],year+Scenario~qname,value="data"),shape=21)+
  geom_line( aes(SSB,Yield,col=Scenario),data=eql)+
  geom_path(aes(SSB,Yield,col=Scenario))+
  geom_point(aes(SSB,Yield,fill=Scenario),shape=21,size=.5,col="grey50")+
  facet_wrap(~Scenario)+
  theme(legend.position="none")+
  scale_y_continuous(limits=c(0,105))
```
**Figure `r iFig=iFig+1;iFig`.** Equilibrium curves and SSB/Yield tracks.

```{r fig2b}
ggplot(cast(rf2[,c(1,3,8:9)],year+Scenario~qname,value="data"),shape=21)+
  geom_line( aes(SSB,Yield,col=Scenario),data=eql)+
  theme(legend.position="bottom")+
  scale_y_continuous(limits=c(0,105))
```
**Figure `r iFig=iFig+1;iFig`.** Equilibrium curves and SSB/Yield tracks.

```{r fig2.5}
ggplot(cast(rfs[,c(1,3,8:9)],year+Scenario~qname,value="data"))+
  geom_path(aes(SSB,rec,col=Scenario))
```
**Figure `r iFig=iFig+1;iFig`.** Stock recruitment relationships.

```{r fig3,fig.width=8,fig.height=5}
dat=as.data.frame(FLQuants("M"  =catch(stkM)/fbar(stkM),
                           "Grw"=catch(stkGrw)/fbar(stkGrw),
                           "Mat"=catch(stkMat)/fbar(stkMat),
                           "SRR"=(catch(stk)/fbar(stk))))

ggplot(subset(dat,year>=50&year<=200))+
  geom_line(aes(year,log(data),col=qname))+
  xlab(expression(F[MSY]))+ylab("CPUE")+
  theme(legend.position="bottom")
```
**Figure `r iFig=iFig+1;iFig`.** CPUE Series



```{r fig7}
ggplot(as.data.frame(m(stkM)))+
    geom_line(aes(year,data,col=factor(age)))+
    theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.** M by year.

```{r fig7b}
ggplot(as.data.frame(m(stkM)))+
    geom_path(aes(fbarMult[year],data,col=factor(age)))+
    xlab(expression(F[MSY]))+
    theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.**  M by F.

```{r fig8}

ggplot(as.data.frame(mat(stkMat)))+
  geom_line(aes(year,data,col=factor(age)))+
  theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.** Proportion mature by year.

```{r fig8b}

ggplot(as.data.frame(mat(stkMat)))+
  geom_path(aes(fbarMult[year],data,col=factor(age)))+
  xlab(expression(F[MSY]))+
  theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.**  Proportion mature by F.

```{r fig9b}
ggplot(as.data.frame(stock.wt(stkGrw)))+
  geom_line(aes(year,data,col=factor(age)))+
  theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.**  Mass-at-age by year.


```{r fig9}
ggplot(as.data.frame(stock.wt(stkGrw)))+
  geom_path(aes(fbarMult[year],data,col=factor(age)))+
  theme(legend.position="none")
```
**Figure `r iFig=iFig+1;iFig`.**  Mass-at-age by F.

##VPA
```{r fig4, fig.height=8}
library(ggplotFL)
library(FLAssess)
stk.=stkM
m(      stk.)=m(stk)
stk.=stk.+VPA(stk.,fratio=1)
plot(FLStocks(M=stkM,SRR=stk.))    
```
**Figure `r iFig=iFig+1;iFig`.** VPA v M scenario.

```{r fig5, fig.height=8}
sep.vpa.control <- FLSepVPA.control(sep.nyr=3, sep.age=2, sep.sel=.1)

stk..<-SepVPA(stk.,sep.vpa.control,fratio=1)
harvest(stk.)=harvest(stk..)
stock.n(stk.)=stock.n(stk..)

plot(FLStocks(M=stkM,SRR=stk.))    
```
**Figure `r iFig=iFig+1;iFig`.** Seperable VPA v M scenario.

```{r fig6, fig.height=8}
stk.=stkMat
mat(stk.)=mat(stk)
stk.=stk.+VPA(stk.,fratio=1)
plot(FLStocks(Mat=stkMat,SRR=stk.))    
```
**Figure `r iFig=iFig+1;iFig`.** VPA v Mat scenario.

```{r fig6b, fig.height=8}
stk.=stkGrw
stock.wt(stk.)=stock.wt(stk)
catch.wt(stk.)=catch.wt(stk)
stk.=stk.+VPA(stk.,fratio=1)
plot(FLStocks(Grw=stkGrw,SRR=stk.))    
```
**Figure `r iFig=iFig+1;iFig`.** VPA v Growth scenario.

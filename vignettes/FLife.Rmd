---
title: "Life History Relationship"
author: "Laurence Kell"
date: "August 13th, 2014"
output: rmarkdown::tufte_handout
---

<!--
%% \VignetteEngine{knitr::knitr}
-->


```{r knitr_init, echo=FALSE, results="asis"}
library(knitr)

# output: rmarkdown::tufte_handout

## Global options
opts_chunk$set(echo    =TRUE,
               eval    =TRUE,
               cache   =!FALSE,
               cache.path="cache/",
               prompt  =FALSE,
               comment =NA,
               message =FALSE,
               tidy    =FALSE,
               warnings=FALSE,
               fig.height=4.5,
               fig.width =4.5)
```


```{r,echo=TRUE,eval=TRUE,message=FALSE,warning=FALSE}
library(ggplot2)
library(FLCore)
library(FLife)
library(ggplotFL)
sigmoid=FLife:::sigmoid
gislason=FLife:::gislason
```

# Introduction

The importance of life history traits has long been recognied (e.g. Holt 1962; Beverton 1963; Cushing 1971). Many studies have shown the relationships between processes such as growth, maturity and natural mortality and life history parameters have been used to devlop priors in stock assesments and to parameterise ecological models.

`FLife` has a variety of methods for modelling life history traits and processes. The                                                                                                                                        `gislasim` method uses these relationships to fill in missing parameters. `FLBRP` and `FLStock` objects can  be generated using the `lh` method. There are also a variety of methods to estimate population parameters, reference points and indices.  

Process considered are mainly age based, although methods also exist for stage and biomass based processes.

# Age based processes

Create life history parameters for a big fish species

```{r age-par}
par=gislasim(FLPar("linf"=100))
par
```

then use the parameters to model the biological processes using functions for growth (`vonB`, `gompertz`). 

All the methods take as their first argument a `numeric`, `FLQuant` or `FLPar` for age, length or weight, and an `FLPar` as the second argument.


```{r age}
age=FLQuant(0:20,dimnames=list(age=0:20))

ln =vonB(age,par)
wt =par["a"]*ln^par["b"]
wt =len2wt(ln,par)
```

Other processes can be modelled using ogives such as `dnormal`
```{r mat}
mat=sigmoid(age,par)
```

```{r, fig.margin=TRUE, fig.cap="Biological properties",echo=FALSE}
ggplot(FLQuants(Length=ln,Mass=wt,Maturity=mat))+
  geom_line(aes(age,data))+
  facet_grid(qname~.,scale="free")+
  xlab("Age")+ylab("")+theme_bw()
```

Natural mortality can either be a function of mass (`lorenzen`) or length (`gislason`)

```{r age-m}
m =FLQuants(Lorenzen=lorenzen(wt,par[c("m1","m2")]),
            Gislason=gislason(ln,par[-(8:9)]))
```

```{r, fig.margin=TRUE, fig.height=4, fig.cap="Natural Mortality",echo=FALSE,eval=FALSE}
ggplot(m)+
  geom_line(aes(age,data,col=qname))+
  xlab("Age")+ylab("Natural Mortality")+theme_bw()+
  theme(legend.title=element_blank(),legend.position="bottom")
```

Selection pattern can be modelled as flat topped or dome shaped as a double normal (´dnormal´)
```{r age-sel}
sel=FLQuants("Flat"=dnormal(age,FLPar(a1="4",sl=3,sr=500)),
             "Dome"=dnormal(age,FLPar(a1="4",sl=3,sr=5)))
```

```{r, fig.margin=TRUE, fig.height=4, fig.cap="Selection patterns",echo=FALSE,eval=FALSE}
ggplot(sel)+
  geom_line(aes(age,data,col=qname))+
  xlab("Age")+ylab("")+theme_bw()
```

```{r,eval=FALSE,echo=FALSE}
dat=data.frame(expand.grid(
                length=seq(10,290,10),year=rep(2001:2010,2)),
                data  =runif(580,0,100)*sample(c(rep(NA,10),rep(10,90)),580,replace=T))
dat=dat[sample(seq(dim(dat)[1],dim(dat)[1])),]

as.FLQuant(dat[sample(seq(dim(dat)[1],dim(dat)[1])),],quant="length")
```

# Life history relationships

The `gislasim` method uses life history relationships to derive the missing parameters, e.g. if only $L_{\infty}$ is known then parameters for growth, maturity, natural mortality can derived. The first argument to `gislasim` is `param`, an `FLPar` object with as a minimum `linf` of the von Bertalanffy equation, then `k` and length and age at maturity $l50$ $a50$ are derived i.e. 

\begin{equation} k=3.15linf^{-0.64} \end{equation}
 
 Gislason et al 2008
 
 \begin{equation} l_{50}=0.72l_{\infty}^{0.93}\end{equation}
    
 \begin{equation}   a_{50}=log(1-(l50/l_{\infty}/-k+t0) \end{equation}

  
Natural mortality parameters from Model 2, Table 1 Gislason 2010

$m1= 0.55(l_{\infty}^{1.44})k$ and $m2=-1.61$        

Other values are not derived from life history theory, if not supplied by the user, are `a` coefficient of length weight relationship, `b` exponent of length weight relationship, `ato95` age at which 95\% of fish are mature, offset to age at which 50\% are mature, `sl` selectivity-at-age parameter, standard deviation of lefthand limb of double normal, `sr` stock recruitment relationship, `s` steepness of stock recruitment relationship, `v` virgin biomass.
 
Selectivity by default is set so age at peak selectivity is the same as age at 50/% mature (a50)

# FLBRP

Equilibrium dynamics; once an ´FLPar´ objective exists an ´FLBRP´ object can be constructed. This combines a stock recruitment relationship with a spawner-per-recruit ($S/R$) and yield-per-recruit ($Y/R$) analyses. The life history parameters are used to derive mass ($W$), proportion mature ($Q$), natural mortality ($M$) and  fishing mortality ($F$) at age. 

\begin{equation}
\begin{array}{l}
S/R=\sum\limits_{i=0}^{p-1} {e^{\sum\limits_{j=0}^{i-1} {-F_j-M_j}}} W_i Q_i +\\
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~e^{\sum\limits_{i=0}^{p-1} {-F_i-M_i}} \frac{W_p Q_p}{1-e^{-F_p-M_p}}
\end{array}
\end{equation} 

\begin{equation}
\begin{array}{l}
Y/R=\sum\limits_{a=r}^{n-1} {e^{\sum\limits_{i=r}^{a-1} {-F_i-M_i}}} W_a\frac{F_a}{F_a+M_a}\left(1-e^{-F_i-M_i} \right) + \\  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~e^{\sum\limits_{i=r}^{n-1} {-F_n-M_n}} W_n\frac{F_n}{F_n+M_n}
\end{array}
\end{equation} 

The second term is the plus-group, i.e. the summation of all ages from the last age to infinity. 

```{r eql}
eql=lh(par)
```

# FLStock
```{r om}
library(FLash)
om=fwd(eql)
```

# Leslie Matrix
```{r leslie}
```

The maximum theoretical rate of increase of a population in the absence of density-dependent regulation is given by

\begin{equation} r=\frac{dN}{dt} \frac{1}{N}  \end{equation}

\noindent where $r$ the intrinsic population growth rate is a function of population size ($N$) and $\frac{dN}{dt}$ the instantaneous rate of increase of the population.

In ecology Leslie matrices (Leslie, 1945) are widely used to estimate $r$ (Picard, 2009) and have been used in fisheries to develop Bayesian priors for use in stock assessment (see McAallister,2001). The Leslie Matrix ($A$) is a transition matrix that models age or stage based dynamics, and can be specified either in numbers or biomass. Each age-class is described by a vector ($B_t$) of length p equal to the terminal age. Entries in the matrix are fecundity ($f_i$) (the quantity of age zero females produced per unit of mature biomass by each age-class) and the survival (and growth if biomass) of an age-class ($s_i$) in each time step $i$, i.e.

\begin{equation}
\begin{array}{l}
b_{1}= f_{2}b_{2}+ ... + f_{3}b_{p}\\
b_{2}=s_{1}b_{1}\\
~~~~~~...\\
b_{p}=s_{p-1}b_{p-1}+s_{p}b_{p}\\
\end{array}
\end{equation}

The matrix of this linear system is 
\begin{equation}
\mathbf{A}=%
\begin{pmatrix}
0 & f_{2} & ... & f_{p} \\ 
s_{1} & 0 & ... & 0 \\ 
 &...&\\
0 & ... & s_{p-1} & s_{p}%
\end{pmatrix}%
\end{equation}

If the initial population is

\begin{equation}
\mathbf{B}^{0}=%
\begin{pmatrix}
b_{1} \\ 
b_{2} \\ 
...\\
b_{p}%
\end{pmatrix}%
\end{equation}

then after time step i=1 the population is given by

\begin{equation}
\mathbf{B}^{i}=\mathbf{A}^{i}\mathbf{B}^{0}
\end{equation}

As $i$ tends to infinity the system reaches equilibrium and the contribution of each age group in the population becomes stable. The population growth rate $r$ is then derived from $\lambda$ the dominant eigenvalue of $A$ (Caswell,1989).

To construct the Leslie matrix requires estimates of $f_i$ and $p_i$. In this study these were derived by combining a stock recruitment relationship with a spawner-per-recruit ($S/R$) and yield-per-recruit ($Y/R$) analyses. The life history parameters were used to derive mass ($W$), proportion mature ($Q$), natural mortality ($M$) and  fishing mortality ($F$) at age. 

\begin{equation}
\begin{array}{l}
S/R=\sum\limits_{i=0}^{p-1} {e^{\sum\limits_{j=0}^{i-1} {-F_j-M_j}}} W_i Q_i +\\
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~e^{\sum\limits_{i=0}^{p-1} {-F_i-M_i}} \frac{W_p Q_p}{1-e^{-F_p-M_p}}
\end{array}
\end{equation} 

\begin{equation}
\begin{array}{l}
Y/R=\sum\limits_{a=r}^{n-1} {e^{\sum\limits_{i=r}^{a-1} {-F_i-M_i}}} W_a\frac{F_a}{F_a+M_a}\left(1-e^{-F_i-M_i} \right) + \\  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~e^{\sum\limits_{i=r}^{n-1} {-F_n-M_n}} W_n\frac{F_n}{F_n+M_n}
\end{array}
\end{equation} 


The second term is the plus-group, i.e. the summation of all ages from the last age to infinity. 

Growth in length is modelled by the Von Bertalanffy growth equation \cite{von1957quantitative}

\begin{equation} L = L_{\infty}(1 - exp(-k(t-t_0)) \end{equation}
         
where $k$ is the rate at which the rate of growth in length declines as length approaches the asymptotic length  $L_{\infty}$ and $t_{0}$ is the hypothetical time at which an individual is of zero length.

Length is converted to mass using the length-weight relationship 
    
\begin{equation} W = aL_t^b \end{equation}

\noindent where $a$ is the condition factor and $b$ is the allometric growth coefficient.

Gislason (2010) showed that M is significantly related to body length, asymptotic length and k. Temperature is non-significant when k is included, since k itself is correlated with temperature. We therefore model M as

\begin{equation}
            M =  0.55L^{1.61}L_{\infty}^{1.44}k
\end{equation} 

Selection pattern of the fishery was represented by a double normal (Hilborn et. al., 2000) with three parameters that describe the age at maximum selection ($a1$), the rate at which the left-hand  limb increases ($sl$) and the right-hand limb decreases ($sr$) which allows flat topped or domed shaped selection patterns to be chosen.
         
\begin{equation}
f(x) = \left\{ \begin{array}{ll}
  		0                                 &\mbox{ if $(a_{50}-x)/a_{95} >  5$} \\
			a_{\infty}                        &\mbox{ if $(a_{50}-x)/a_{95} < -5$} \\
			\frac{m_{\infty}}{1.0+19.0^{(a_{50}-x)/_{95})}} &\mbox{ otherwise}
		\end{array}
       \right.
\end{equation}

The relationship between stock and recruitment was modelled by a Beverton and Holt stock-recruitment relationship (Beverton and Holt, 1993) reformulated in terms of steepness ($h$), virgin biomass ($v$) and $S/R_{F=0}$

\begin{equation}
R=\frac{0.8R_0h}{0.2S/R_{F=0}R_0(1-h)+(h-0.2)S}
\end{equation} 

\noindent where steepness is the ratio of recruitment at 20\% of virgin biomass to virgin recruitment ($R_0$) and $S/R_{F=0}$ is the spawner per recruit at virgin biomass, i.e. when fishing mortality is zero. Steepness is difficult to estimate from stock assessment data sets as there is often insufficient contrast in biomass levels required for its estimation \cite{pepin2015reconsidering}.

S is spawning stock biomass, the sum of the products of the numbers of females, $N$, proportion mature-at-age, $Q$ and their mean fecundity-at-age, $F$, i.e. 

\begin{equation} S = \sum\limits_{i=0}^{p} {N_iQ_iF_i} \end{equation}

where fecundity-at-age is assumed proportional to biomass and the sex ratio to be 1:1. Proportion mature is 50\% at the age that attains a length of $l50$, 0\% below this age and 100\% above. 


# Reference points and stock indicators
```{r refpt}
```

# Catch curve analyses
```{r cc}
```

# Elasticity Analysis
```{r elas}
```


# Indicators

The length where the biomass of an unfished cohort reaches a maximum is known as $L_{opt}$ is (Beverton and Holt, 1993). It is a reference point for growth overfishing, since if most fish caught are below this length then yield from the fishery is potentially being lost. Depending on the level of infomation $L_{opt}$ can be estimated as   
  
two thirds of $L_{max}$  
  
$L_{\infty}\frac{3}{3+M/k}$   
    
or from a yield per recruit analysis
dimnames(par)$params
Where $L_{max}$ is the maximum observed size, $M$ the instantaneous natural mortality and $k$ the growth rate from the Von Bertalannfy growth curve (Von Bertalannfy, 1957).


```{r par,echo=TRUE,eval=!TRUE,message=FALSE,warning=FALSE}
#data(lnMn)
#data(pars)

data(ln)
data(pars)

lines=ldply(pars,function(x) data.frame(Linf =c(x["linf"]),
                                        L50  =c(x["l50"]),
                                        Lopt =c(x["linf"]*2/3),
                                        Lopt2=c(lopt2(x,.6))))
names(lines)[1]="stock"
dat=melt(lines,id="stock")
names(dat)[2]="Quantity"

ggplot(ln)+
  geom_hline(aes(yintercept=value,col=Quantity),
             data=dat,show_guide=T)+
  geom_ribbon(aes(year,ymin=p25,ymax=p75),alpha=.2)+
  geom_line(  aes(year,p50))+
  facet_grid(stock~.,scale="free")+
  theme_bw()+
  xlab("Year")+ylab("Length (cm)")+
  expand_limits(y=0) 
```

# Population Growth Rate



# References

R.~Beverton and S.~Holt.
\newblock \emph{On the dynamics of exploited fish populations}, volume~11.
\newblock Springer, 1993.

Von~Bertalanffy, L. (1957).
\newblock Quantitative laws in metabolism and growth.
\newblock {\em Quarterly Review of Biology}, pages 217--231.

23 Leslie PH (1945) On the use of matrices in certain population mathematics. Biometrika 33: 183–212. doi: 10.1093/biomet/33.3.183 

[9] McAllister MK, Pikitch EK, Babcock EA (2001) Using demographic methods to construct Bayesian priors for the intrinsic rate of increase in the Schaefer model and implications for stock rebuilding. Canadian Journal of Fisheries and Aquatic Sciences 58: 1871–1890. doi: 10.1139/cjfas-58-9-1871 

[39] Picard N, Chagneau P, Mortier F, Bar-Hen A (2009) Finding confidence limits on population growth rates: Bootstrap and analytic methods. Mathematical Biosciences 219: 23–31 doi:10.1016/j.mbs.2009.02.002. doi: 10.1016/j.mbs.2009.02.002 
 